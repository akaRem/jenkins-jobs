- job-template:
    # Upgrade test. Takes base iso, deploys TEST_GROUP snapshot, then
    # runs UPGRADE_TEST_GROUP test on this env.
    #
    # Variables required:
    #
    # dist
    #     OPENSTACK_RELEASE variable. 'centos' or 'ubuntu'.
    # testgroup
    #     Initial test group. It is used for base deployment.
    # upgrade_testgroup
    #     Test group for upgrade test. Upgrade tarball will be used.
    # description
    #     Job description.
    # timeout
    #     Job timeout.
    # base_iso_magnet_link
    #     Magnet link for previous Fuel release iso.
    # upgrade_iso_magnet_link
    #     Magnet link for Fuel iso which should be tested.
    # weight
    #     Job weight
    # node
    #     Label of node where runs job
    # properties
    #     Default parameteres required for the job
    name: '8.0.upgrades.{dist}.{upgrade_testgroup}'
    description: '{description}'
    concurrent: true
    node: '{node}'
    logrotate:
      artifactDaysToKeep: -1
      artifactNumToKeep: -1
      daysToKeep: 30
      numToKeep: 50

    properties:
    - heavy-job:
        weight: '{weight}'

    parameters:
    - string:
        name: REPO_NAME
        default: 'fuel-qa'
    - string:
        name: BASE_REPO_BRANCH
        default: 'stable/7.0'
    - string:
        name: UPGRADE_REPO_BRANCH
        default: 'stable/8.0'
    - string:
        name: BASE_ISO_MAGNET_LINK
        default: 'magnet:?xt=urn:btih:21b4d46c9f1cec02e336b1f9771d4f7c27ec724b&dn=MirantisOpenStack-7.0.iso&tr=http%3A%2F%2Ftracker01-bud.infra.mirantis.net%3A8080%2Fannounce&tr=http%3A%2F%2Ftracker01-mnv.infra.mirantis.net%3A8080%2Fannounce&tr=http%3A%2F%2Ftracker01-msk.infra.mirantis.net%3A8080%2Fannounce&ws=http%3A%2F%2Fvault.infra.mirantis.net%2FMirantisOpenStack-7.0.iso'
        description: "7.0 ISO magnet link"
    - string:
        name: UPGRADE_ISO_MAGNET_LINK
        default: 'magnet:?xt=urn:btih:4709616bca3e570a951c30b7cf9ffeb2c0359f5c&dn=MirantisOpenStack-8.0.iso&tr=http%3A%2F%2Ftracker01-bud.infra.mirantis.net%3A8080%2Fannounce&tr=http%3A%2F%2Ftracker01-scc.infra.mirantis.net%3A8080%2Fannounce&tr=http%3A%2F%2Ftracker01-msk.infra.mirantis.net%3A8080%2Fannounce&ws=http%3A%2F%2Fvault.infra.mirantis.net%2FMirantisOpenStack-8.0.iso'
        description: "8.0 ISO magnet link"
    - string:
        name: BASE_FUEL_PROPOSED_REPO_URL
        default: 'http://perestroika-repo-tst.infra.mirantis.net/mos-repos/centos/mos7.0-centos6-fuel/proposed/x86_64'
    - string:
        name: UPGRADE_FUEL_PROPOSED_REPO_URL
        default: 'http://packages.fuel-infra.org/repositories/centos/liberty-centos7/proposed/x86_64'
    - string:
        name: OPENSTACK_RELEASE
        default: '{dist}'
        description: Base distribution
    - string:
        name: TEST_GROUP
        default: '{testgroup}'
    - string:
        name: UPGRADE_TEST_GROUP
        default: '{upgrade_testgroup}'
    - string:
        name: ENV_PREFIX
        default: '8.0.upgrades.{dist}.{upgrade_testgroup}'

    scm:
    - main-git:
        reponame: $REPO_NAME
        repobranch: $BASE_REPO_BRANCH
        basedir: '$REPO_NAME-base'
    - main-git:
        reponame: $REPO_NAME
        repobranch: $UPGRADE_REPO_BRANCH
        basedir: '$REPO_NAME-upgrade'

    wrappers:
    - timeout:
        fail: false
        timeout: '{timeout}'
        write-description: true
    - ansicolor:
        colormap: xterm

    builders:
    - inject:
        properties-content: |
          VENV_PATH={venvpath}
          CONNECTION_STRING=qemu+tcp://127.0.0.1:16509/system
    - guess-mirror
    - inject:
        properties-content: '{properties}'
    - shell:
        !include-raw-escape 'scripts/upgrade_system_tests.sh'

    publishers:
    - archive:
        allow-empty: true
        artifacts: '**/nosetests.xml,*/logs/*'
        latest-only: false
    - post-destroy-vms
    - junit:
        keep-long-stdio: false
        results: '**/nosetests.xml'
    - description-setter:
        regexp: "'Description string: (.*)'"
        regexp-for-failed: "'Description string: (.*)'"

