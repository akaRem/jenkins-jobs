#
# Template used to run the plugin's unit tests
#
# If the unit tests pass, the job will start the deployment test
#
- job-template:
    name: '{version}.fuel-plugin.{plugin_name}.verify'
    node: '{node_label}'
    project-type: multijob

    description: |
      Job used to run the unit tests of <b>fuel-plugin-{plugin_name}</b><ul>
      <li><b>Repository:</b>
        <a href="https://github.com/openstack/{plugin_repo}">
          https://github.com/openstack/{plugin_repo}
        </a>
      </li>
      <li><b>Branch:</b> {plugin_branch}</li>
      <li><b>Owner:</b> {plugin_owner}</li>
      </ul>

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: 'refs/heads/{plugin_branch}'

    scm:
      - review-openstack-org:
          project-basedir: 'plugin'
          project-name: 'openstack/{plugin_repo}'

    triggers:
      - review-openstack-org:
          project-branch-pattern: '{plugin_branch}'
          project-name-pattern: 'openstack/{plugin_repo}'

    builders:
      - inject:
          # Define the directory containing the plugin project
          properties-content: |
            PLUGIN_DIR=plugin/{plugin_dir}
      - shell:
          !include-raw-escape: ./builders/plugin-verify.sh
      - multijob:
          name: Test plugin
          condition: SUCCESSFUL
          projects:
            - name: '{version}.fuel-plugin.{plugin_name}.deploy-test'
              kill-phase-on: FAILURE
              node-parameters: true
              # Content of this file is generated by builders/plugin-verify.sh
              property-file: plugin-verify.envfile

    publishers:
      - archive:
          artifacts: 'plugin/*.rpm'





