#
# Template used to publish plugin package
#
# When plugin is successfully published job will start deployment test phase
#
- job-template:
    name: '{version}.fuel-plugin.{plugin_name}.publish'
    node: '{node_label}'

    description: |
      Job used to publish fuel-plugin <b>{plugin_name}</b>
      <ul>
        <li>
          <b>Repository:</b>
          <a href="https://github.com/openstack/{plugin_repo}">
            https://github.com/openstack/{plugin_repo}
          </a>
        </li>
        <li>
          <b>Branch:</b> {plugin_branch}
        </li>
        <li>
          <b>Owner:</b> {plugin_owner}
        </li>
      </ul>

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: 'refs/heads/master'

    scm:
      - review-fuel-infra:
          project-basedir: 'trsync'
          project-name: 'infra/trsync'

    wrappers:
      - ssh-agent-credentials:
          users:
            - '{ssh-creds-plugin-publisher}'

    builders:
      - inject:
          # Define directory with plugin
          properties-content: |
            PLUGIN_NAME={plugin_name}
            PLUGIN_BRANCH={plugin_branch}
            PLUGIN_USER={username-plugin-publisher}
            GERRIT_EVENT_TYPE=change-merged-event

      - shell:
          !include-raw-escape: ./builders/plugin-publish.sh
