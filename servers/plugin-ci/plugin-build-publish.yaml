#
# Template used to build plugin
#
# When plugin is successfully built job will start deployment test phase
#
- job-template:
    name: '{version}.fuel-plugin.{plugin_name}.build.publish'

    description: |
      Job used to build fuel-plugin <b>{plugin_name}</b>
      <ul>
        <li>
          <b>Repository:</b>
          <a href="https://github.com/openstack/{plugin_repo}">
            https://github.com/openstack/{plugin_repo}
          </a>
        </li>
        <li>
          <b>Branch:</b> {plugin_branch}
        </li>
        <li>
          <b>Owner:</b> {plugin_owner}
        </li>
      </ul>

    node: '{node_label}'
    project-type: multijob

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: 'refs/heads/{plugin_branch}'

    scm:
      - review-openstack-org:
          project-basedir: 'plugin'
          project-name: 'openstack/{plugin_repo}'
      - fuel-plugins:
          project-refspec: '{fuel_plugins_refspec}'

    triggers:
      - review-openstack-org:
          project-branch-pattern: '{plugin_branch}'
          project-name-pattern: 'openstack/{plugin_repo}'
      - gerrit:
          trigger-on:
            - change-merged-event
          projects:
            - project-compare-type: PLAIN
              project-pattern: 'openstack/{plugin_repo}'
              branch-pattern: '{plugin_branch}'
          silent: true

    wrappers:
      - ssh-agent-credentials:
          users:
            - '{ssh-creds-plugin-publisher}'

    builders:
      - inject:
          # Define directory with plugin
          properties-content: |
            PLUGIN_DIR=plugin/{plugin_dir}
            PLUGIN_NAME={plugin_name}
            PLUGIN_BRANCH={plugin_branch}
            PLUGIN_USER={username-plugin-publisher}
      - inject:
          # inject custom variables
          properties-content: '{plugin_custom_variables}'
      - shell:
          !include-raw-escape: ./builders/plugin-build.sh
      - shell:
          !include-raw-escape: ./builders/plugin-publish.sh
      - multijob:
          name: Test plugin
          condition: SUCCESSFUL
          projects:
            - name: '{version}.fuel-plugin.{plugin_name}.deploy-test'
              kill-phase-on: FAILURE
              node-parameters: true
              # Content of this file is generated by builders/plugin-build.sh
              property-file: plugin-build.envfile

    publishers:
      - archive:
          artifacts: 'plugin/*.rpm,plugin/*.fp'
