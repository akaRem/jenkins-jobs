- job-template:
    name: '{mos_version}-pkg-systest-{os}'
    concurrent: true
    logrotate:
      artifactDaysToKeep: 90
      daysToKeep: 90
    properties:
      - heavy-job:
          weight: 8
      - inject:
          properties-content: |
            PRODUCT_JENKINS_URL={product_jenkins_url}
            ISO_JOB_NAME={mos_version}.test_all
            OPENSTACK_RELEASE={os}
            OS_TYPE={os}

            ENV_PREFIX={mos_version}-pkg-systest-{os}-{distro}
            UBUNTU_DIST={main_ubuntu_release}

            REMOTE_REPO_HOST={repo-host}

            DEB_DIST_NAME={project-name}{mos_version}
            DEB_REPO_PATH={rel-path-prefix}/ubuntu/{mos_version}
            DEB_COMPONENTS=main restricted

            RPM_REPO_PATH={rel-path-prefix}/centos/{project-name}{mos_version}-{main_centos_release}-fuel/os/x86_64/
    parameters:
      - string:
          name: TEST_GROUP
          default: 'bvt_2'
      - bool:
          name: NEUTRON_ENABLE
          default: 'true'
      - string:
          name: MIRROR_UBUNTU
          description: |
            If empty, it will be set automatically based on UBUNTU_MIRROR_ID value.
            <p>
            deb http://../ubuntu trusty main universe multiverse|deb http://../ubuntu trusty-updates main universe multiverse|deb http://../ubuntu trusty-security main universe multiverse|deb http://../ubuntu trusty-proposed main universe multiverse
      - string:
          name: EXTRA_DEB_REPOS
          default: 'deb http://{repo-host}/{rel-path-prefix}/ubuntu/{mos_version} {project-name}{mos_version} main restricted,1010'
          description: 'deb http://... trusty main(,prio1)|deb http://... trusty main(,prio2)'
      - string:
          name: EXTRA_DEB_REPOS_PRIORITY
          default: '1052'
      - string:
          name: EXTRA_RPM_REPOS
          default: 'release-repo,http://{repo-host}/{rel-path-prefix}/centos/{project-name}{mos_version}-{main_centos_release}-fuel/os/x86_64/,98'
          description: 'reponame1,http://...(,prio1)|reponame2,http://...(,prio2)'
      - string:
          name: EXTRA_RPM_REPOS_PRIORITY
          default: '1'
      - string:
          name: PRODUCT_JENKINS_URL
          default: '{product_jenkins_url}'
      - bool:
          name: REBUILD_ISO
          default: false
      - string:
          name: ENV_PREFIX
          default: '{mos_version}-pkg-systest-{os}-{distro}'
    scm:
      - upstream:
          branch: '{fuel-main-branch}'
          repo: fuel-main
          fuel-namespace: '{fuel-namespace}'
      - upstream:
          branch: '{fuel-qa-branch}'
          repo: fuel-qa
          fuel-namespace: '{fuel-namespace}'
    triggers:
      - zuul
      - timed: "H */12 * * *"
    builders:
      - shell: |
          #!/bin/bash -xe
          # Clean logs from previous runs
          rm -vf fuel-qa/logs/* buildresult.params
      - copyartifact:
          project: '{mos_version}-pkg-pipeline-{os}'
          filter: 'buildresult.params'
          which-build: last-successful
          parameter-filters: ZUUL_CHANGE=${{ZUUL_CHANGE}},ZUUL_PATCHSET=${{ZUUL_PATCHSET}}
          optional: true
      - copyartifact:
          project: 'devops.{mos_version}.env'
          filter: 'fuel_qa_commit.txt,magnet_link.txt,ubuntu_mirror_id.txt'
          which-build: last-successful
      - inject:
          # injects set of variables about built packages
          properties-file: 'buildresult.params'
      - conditional-step:
          condition-kind: strings-match
          condition-string1: '{pkg_type}'
          condition-string2: 'rpm'
          steps:
            - inject:
                properties-content: |
                  EXTRA_RPM_REPOS=${{EXTRAREPO}}
      - conditional-step:
          condition-kind: strings-match
          condition-string1: '{pkg_type}'
          condition-string2: 'deb'
          steps:
            - inject:
                properties-content: |
                  EXTRA_DEB_REPOS=${{EXTRAREPO}}
      - inject:
          # injects variable FUEL_QA_COMMIT
          properties-file: 'fuel_qa_commit.txt'
      - inject:
          # injects variable MAGNET_LINK
          properties-file: 'magnet_link.txt'
      - inject:
          # injects variable UBUNTU_MIRROR_ID
          properties-file: 'ubuntu_mirror_id.txt'
      - systest
    wrappers:
      - timeout:
          fail: true
          timeout: 210
      - timestamps
      - ansicolor
    publishers:
      - archive:
          allow-empty: true
          artifacts: '**/nosetests.xml, logs/*, fuel-qa/logs/*'
          latest-only: false
      - logparser:
          parse-rules: '/var/lib/jenkins/fuellib.parser'
          unstable-on-warning: false
          fail-on-error: false
      - junit:
          keep-long-stdio: false
          results: '**/nosetests.xml'

    node: '{systest-node}'
