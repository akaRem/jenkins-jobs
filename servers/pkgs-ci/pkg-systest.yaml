- job-template:
    name: '{mos_version}-pkg-systest'
    concurrent: true
    logrotate:
      artifactDaysToKeep: 90
      daysToKeep: 90
    properties:
      - heavy-job:
          weight: 8
      - inject:
          properties-content: |
            ENV_PREFIX={mos_version}-pkg-systest
            PRODUCT_JENKINS_URL={product_jenkins_url}
            ISO_JOB_NAME={mos_version}.test_all
            REBUILD_ISO=false
    parameters:
      - string:
          name: MAGNET_LINK
      - string:
          name: TEST_GROUP
          default: 'bvt_2'
      - string:
          name: OPENSTACK_RELEASE
          default: 'Ubuntu'
      - string:
          name: ENV_PREFIX
          default: '{mos_version}-pkg-systest'
          description: Define env prefix name. This parameter should not be changed
      - string:
          name: NEUTRON_ENABLE
          default: 'true'
      - string:
          name: UBUNTU_MIRROR_ID
          default: latest
          description: |
            'latest' - latest available; 'latest-stable' - mirror from successful run of 7.0.test_all job; 'ubuntu-2015-01-01-030500'
      - string:
          name: MIRROR_UBUNTU
          default:
          description: |
            If empty, it will be set automatically based on UBUNTU_MIRROR_ID value.
            <p>
            deb http://../ubuntu trusty main universe multiverse|deb http://../ubuntu trusty-updates main universe multiverse|deb http://../ubuntu trusty-security main universe multiverse|deb http://../ubuntu trusty-proposed main universe multiverse
      - string:
          name: EXTRA_DEB_REPOS
          default: ''
          description: 'deb http://... trusty main'
      - string:
          name: EXTRA_DEB_REPOS_PRIORITY
          default: '1052'
      - string:
          name: PRODUCT_JENKINS_URL
          default: '{product_jenkins_url}'
      - string:
          name: ISO_JOB_NAME
          default: '{mos_version}.test_all'
    scm:
      - upstream:
          branch: 'master'
          repo: fuel-main
          fuel-namespace: '{fuel-namespace}'
      - upstream:
          branch: 'master'
          repo: fuel-qa
          fuel-namespace: '{fuel-namespace}'
      - fuel-infra:
          scm-user: '{scm-user}'
          scm-repo: '{scm-ci-status-client-repo}'
          scm-basedir: '{scm-ci-status-client-basedir}'
          scm-credentials-id: '{scm-credentials-id}'
          scm-branch: '{scm-ci-status-client-branch}'
    triggers:
      - zuul
    builders:
      - shell: |
          #!/bin/bash -xe

          # Gerrit parameters
          export GERRIT_HOST=${{GERRIT_HOST:-{gerrit-host}}}
          export GERRIT_PORT=${{GERRIT_PORT:-{gerrit-port}}}
          export GERRIT_USER=${{GERRIT_USER:-{gerrit-user}}}

          ci-status-client/ci-status-report.sh start

          # Clean logs from previous runs
          rm -f fuel-qa/logs/*
      - copyartifact:
          project: '{mos_version}-pkg-pipeline-centos'
          filter: 'ci_status_params, rpm.publish.setenvfile'
          which-build: last-successful
          parameter-filters: ZUUL_CHANGE=${{ZUUL_CHANGE}},ZUUL_PATCHSET=${{ZUUL_PATCHSET}}
          optional: true
      - copyartifact:
          project: '{mos_version}-pkg-pipeline-ubuntu'
          filter: 'ci_status_params, deb.publish.setenvfile'
          which-build: last-successful
          parameter-filters: ZUUL_CHANGE=${{ZUUL_CHANGE}},ZUUL_PATCHSET=${{ZUUL_PATCHSET}}
          optional: true
      - shell: /bin/bash -xec 'touch {{deb,rpm}}.publish.setenvfile'
      - inject:
          properties-file: 'ci_status_params'
      - inject:
          properties-file: 'rpm.publish.setenvfile'
      - inject:
          properties-file: 'deb.publish.setenvfile'
      - systest
    wrappers:
      - gerrit-creds
      - timeout:
          fail: true
          timeout: 210
      - timestamps
      - ansicolor
    publishers:
      - post-tasks:
         - matches:
            - log-text: Building
              operator: AND
           script: |
             #!/bin/bash -xe

             # Gerrit parameters
             export GERRIT_HOST=${{GERRIT_HOST:-{gerrit-host}}}
             export GERRIT_PORT=${{GERRIT_PORT:-{gerrit-port}}}
             export GERRIT_USER=${{GERRIT_USER:-{gerrit-user}}}

             ci-status-client/ci-status-report.sh stop
      - archive:
          allow-empty: true
          artifacts: '**/nosetests.xml, logs/*, ci_status_params, fuel-qa/logs/*'
          latest-only: false
      - logparser:
          parse-rules: '/var/lib/jenkins/fuellib.parser'
          unstable-on-warning: false
          fail-on-error: false
      - junit:
          keep-long-stdio: false
          results: '**/nosetests.xml'

    node: '{systest-node}'
