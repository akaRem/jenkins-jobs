################################################################################
# Job Templates
################################################################################

- job-template:
    name: '{mos_version}-fuel-pkg-pipeline-{distro}'
    concurrent: True
    description: |
        This job builds a package and then publishes it by triggerring publisher job.<br>
        After publishing are triggered test jobs:
        <ul>
          <li> install test for just built packages
          <li> system test using just built packages
        </ul>
    scm:
      - perestroika
    wrappers:
      - gerrit-creds
      - timeout:
          timeout: 300
      - timestamps
      - ansicolor
    triggers:
      - zuul
    builders:
      - shell: |
          #!/bin/bash -xe

          # FIXME: use perestroika from openstack/fuel-mirror
          # checkout fuel-mirror to ${{WORKSPACE}}/fuel-mirror
          # and then copy perestroika directory to root ${{WORKSPACE}}
          cp -rv ${{WORKSPACE}}/fuel-mirror/perestroika/* ${{WORKSPACE}}
      - shell:
          !include-raw builders/pkg_build.sh.template
      - trigger-builds:
          - project: '{mos_version}-fuel-pkg-publish-{distro}'
            current-parameters: true
            property-file: buildresult.params
            block: true
      - copyartifact:
            project: '{mos_version}-fuel-pkg-publish-{distro}'
            filter: '{pkg_type}.publish.setenvfile'
            parameter-filters: 'ZUUL_UUID=${{ZUUL_UUID}}'
            which-build: 'last-completed'
    publishers:
      - 'email-alert-on-merge'
      - archive:
          artifacts: 'buildresult.params, {pkg_type}.publish.setenvfile'
          allow-empty: True

    node: '{build-node}'

################################################################################
# Job Groups
################################################################################
