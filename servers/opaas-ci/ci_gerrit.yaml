- job-template:
    name: '{name}-{project-branch}-gerrit-check'
    node: '{node_label}'
    properties:
      - heavy-job:
          weight: '{weight}'
    concurrent: true
    parameters:
      - text:
          name: ADDITIONAL_PARAMETERS
          default: |
            OS_IMAGE={rc_os_image}
            UPLOAD_TO_OS=true
            APPS_CLEAN=true
            OS_CLEANUP_BEFORE=true
            #
            GIT_REPO=openstack/ci-cd-pipeline-app-murano
            #
            APP_PREFIX=io.murano.opaas
            APPS_ROOT=murano-apps/
            RUN_TEST=deploy_cicd_apps
    scm:
      - review-openstack-org:
          skip-tag: true
          project-basedir: ''
          project-name: '{project-name}'
          credentials-id: '{ssh-creds-openstack-ci-jenkins}'
    triggers:
      - review-openstack-org:
          project-name: '{project-name}'
          project-branch: '{project-branch}'
          comment-contains-value-regexp: '{gerrit_trigger_on_recheck_regexp}'
          failed_vote: true
    wrappers:
      - timeout:
          timeout: 300
      - ansicolor:
            colormap: xterm
      - timestamps
      - ssh-creds-slave-jenkins
    builders:
      - inject_log_path
      - inject:
          properties-content: '$ADDITIONAL_PARAMETERS'
      - shell:
          !include-raw-escape: builders/apps_uploader.sh
    publishers:
      - console-log
      - opaas-log

- job-template:
    name: '{name}-{project-branch}-gerrit-linters'
    node: '{node_label}'
    properties:
      - heavy-job:
          weight: '{weight}'
    concurrent: true
    scm:
      - review-openstack-org:
          skip-tag: true
          project-basedir: ''
          project-name: '{project-name}'
          credentials-id: '{ssh-creds-openstack-ci-jenkins}'
    triggers:
      - review-openstack-org:
          project-name: '{project-name}'
          project-branch: '{project-branch}'
          comment-contains-value-regexp: '{gerrit_trigger_on_recheck_regexp}'
          failed_vote: false
    wrappers:
      - timeout:
          timeout: 30
      - ansicolor:
            colormap: xterm
      - timestamps
      - ssh-creds-slave-jenkins
    builders:
      - inject_log_path
      - shell: |
          #!/bin/bash
          printenv |sort -u
          # remove export, after #LP1607791 fix
          export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:${{PATH}}
          tox -v -e linters
    publishers:
      - console-log
      - opaas-log
