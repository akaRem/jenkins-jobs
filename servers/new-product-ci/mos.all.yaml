- defaults:
    name: '{version}-mos.all'
    node: iso
    description: 'Build ISO with Fuel downstream'
    email: 'ci+builds@mirantis.com, fuel-build@mirantis.com'
    timer: ''
    variables: ''
    git-root: 'ssh://product-ci@review.fuel-infra.org:29418/openstack/'

- job-template:
    name: '{version}-mos.all'
    defaults: '{version}-mos.all'
    properties:
      - build-timestamp
      - heavy-job:
          weight: 1
      - throttle:
          categories:
            - iso_builds
          max-per-node: 1
          option: category
    parameters:
      - text:
          name: ADDITIONAL_VARIABLES
          default: '{variables}'

    builders:
      - inject: # Defaults
          properties-content: |
            FUELLIB_REPO={git-root}fuel-library.git
            NAILGUN_REPO={git-root}fuel-web.git
            PYTHON_FUELCLIENT_REPO={git-root}python-fuelclient.git
            FUEL_AGENT_REPO={git-root}fuel-agent.git
            FUEL_NAILGUN_AGENT_REPO={git-root}fuel-nailgun-agent.git
            ASTUTE_REPO={git-root}fuel-astute.git
            OSTF_REPO={git-root}fuel-ostf.git
            FUEL_MIRROR_REPO={git-root}fuel-mirror.git
            FUELMENU_REPO={git-root}fuel-menu.git
            SHOTGUN_REPO={git-root}shotgun.git
            NETWORKCHECKER_REPO={git-root}network-checker.git
            FUELUPGRADE_REPO={git-root}fuel-upgrade.git
            FUEL_UI_REPO={git-root}fuel-ui.git

            ISO_ID={version}{mod}
            UBUNTU_MIRROR_ID=latest
            CENTOS_MIRROR_ID=latest
            MOS_CENTOS_ROOT=/mos-repos/centos/mos{version}-centos7-fuel/
            MOS_UBUNTU_TARGET=master.target.txt
            MOS_UBUNTU_ROOT=/mos-repos/ubuntu/
            MIRROR_MOS_UBUNTU_SUITE=mos-master
      - inject: # Overrides
          properties-content: |
            $ADDITIONAL_VARIABLES
      - shell:
          !include-raw-escape ../../common/scripts/all.sh

    publishers:
      - archive:
          allow-empty: false
          artifacts: artifacts/*.txt, artifacts/*changelog
          latest-only: false
      - description-setter:
          regexp: (<a href=.*a> <a href=.*a><br>magnet.*<br>)
          set-for-matrix: false
      - email-default:
          mail-to: '{email}'
      - trigger-parameterized-builds:
        - project: 'deploy_iso_on_cachers'
          property-file: magnet_link.txt
          condition: UNSTABLE_OR_BETTER
        - project: '{version}{mod}.test_all'
          condition: UNSTABLE_OR_BETTER
          predefined-parameters: |
            UPSTREAM_BUILD_URL=$BUILD_URL
            UPSTREAM_BUILD_NUMBER=$BUILD_NUMBER
            BUILD_MIRROR_URL=$BUILD_MIRROR_URL

    scm:
      - git:
          url: '{git-root}fuel-main.git'
          branches:
            - 'origin/{branch}'
          wipe-workspace: false
          clean:
            before: true

    triggers:
      - timed: '{timer}'
    wrappers:
      - timeout:
          timeout: 120
          fail: true
      - product-ci-credentials
