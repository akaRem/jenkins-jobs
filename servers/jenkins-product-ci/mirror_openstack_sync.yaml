- job-template:
    name: 'mirror-openstack-{osversion}-{mirrordist}'
    node: mirror_openstack_sync
    description: |
        This job will fetch remote upstream repo to timestamp<br>
        It and serve it using http and rsync protocols.<br><br>
        Default variable (SYNC_LOCATIONS) set multiple additional external targets in different locations.<br>
        Maintenance contacts: #fuel-build

    parameters:
      - string:
          name: SOURCE_URL
          default: '{src_url}'
          description: 'Url to make mirror of. (supported by rsync)'
      - string:
          name: MIRROR_NAME
          default: '{mirrordist}'
          description: 'Name of mirror to sync'
      - string:
          name: SYNC_LOCATIONS
          default: 'rsync://osci-mirror-msk.msk.mirantis.net/mirror-sync/openstack rsync://osci-mirror-srt.srt.mirantis.net/mirror-sync/openstack rsync://osci-mirror-kha.kha.mirantis.net/mirror-sync/openstack rsync://mirror.seed-us1.fuel-infra.org/mirror-sync/openstack rsync://mirror.seed-cz1.fuel-infra.org/mirror-sync/openstack rsync://osci-mirror-poz.infra.mirantis.net/mirror-sync/openstack '
          description: 'List of other rsync mirrors to synchronize. (" " separate values)'
      - string:
          name: SNAPSHOT_LIFETIME
          default: '30'
          description: |
              Maximum lifetime of snapshot (number of days). '0' mean that old
              snapshots will not be deleted. 'None' mean that all snapshots excluding
              latest will be deleted.
      - string:
          name: UPDATED_SYMLINKS
          default: '{updated_symlinks}'
          description: 'List of symlinks to current snapshot separated by the space.'
      - string:
          name: TIMESTAMP
          default: ''
          description: 'Use specified timestamp instead of autogenerated. (YYYY-MM-DD-hhmmss)'

    publishers:
      - email:
          recipients: fuel-build+alert@mirantis.com
      - junit:
          results: '*.xml'

    builders:
      - shell:
          !include-raw-escape: './builders/mirror_pull_push.sh'

    wrappers:
      - ssh-agent-credentials:
          users:
            - '60262544-8924-4718-aa4e-7e629cc2f5d3'

- project:
    name: mirror_openstack_sync
    jobs:
      - 'mirror-openstack-{osversion}-{mirrordist}':
          mirrordist: jessie
          osversion: mitaka
          mirror_dir: '{mirrordist}%timestamp%'
          src_url: 'ftp@{osversion}-{mirrordist}.pkgs.mirantis.com:debian'
          updated_symlinks: '{mirrordist}'
          rsync_extra_params: ''
      - 'mirror-openstack-{osversion}-{mirrordist}':
          mirrordist: trusty
          osversion: mitaka
          mirror_dir: '{mirrordist}%timestamp%'
          src_url: 'ftp@{osversion}-{mirrordist}.pkgs.mirantis.com:debian'
          updated_symlinks: '{mirrordist}'
          rsync_extra_params: ''
